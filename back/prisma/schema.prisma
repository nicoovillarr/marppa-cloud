generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventType {
  SYSTEM_RESET
  SYSTEM_RESET_FAILED
  SYSTEM_RESET_SUCCESS
  SYSTEM_TEST_EVENT

  WORKER_CREATE
  WORKER_CREATE_FAILED
  WORKER_CREATED

  WORKER_UPDATE
  WORKER_UPDATED

  WORKER_START
  WORKER_STARTED

  WORKER_TERMINATE
  WORKER_TERMINATED

  WORKER_DELETE
  WORKER_DELETED

  WORKER_IMAGE_CREATE
  WORKER_IMAGE_CREATE_FAILED
  WORKER_IMAGE_CREATED

  ZONE_CREATE
  ZONE_CREATED

  ZONE_DELETE
  ZONE_DELETED

  NODE_ASSIGN_WORKER
  NODE_ASSIGNED_WORKER

  NODE_UNASSIGN_WORKER
  NODE_UNASSIGNED_WORKER

  NODE_CREATE_FIBER
  NODE_CREATE_FIBER_FAILED
  NODE_FIBER_CREATED

  NODE_UPDATE_FIBER
  NODE_UPDATE_FIBER_FAILED
  NODE_FIBER_UPDATED

  NODE_DELETE_FIBER
  NODE_DELETE_FIBER_FAILED
  NODE_FIBER_DELETED

  PORTAL_CREATE
  PORTAL_CREATE_FAILED
  PORTAL_CREATED

  PORTAL_UPDATE
  PORTAL_UPDATE_FAILED
  PORTAL_UPDATED

  PORTAL_SYNC
  PORTAL_SYNC_FAILED
  PORTAL_SYNCED

  PORTAL_DELETE
  PORTAL_DELETE_FAILED
  PORTAL_DELETED

  TRANSPONDER_CREATE
  TRANSPONDER_CREATE_FAILED
  TRANSPONDER_CREATED

  TRANSPONDER_UPDATE
  TRANSPONDER_UPDATE_FAILED
  TRANSPONDER_UPDATED

  TRANSPONDER_DELETE
  TRANSPONDER_DELETE_FAILED
  TRANSPONDER_DELETED
}

enum ResourceStatus {
  INACTIVE
  QUEUED
  PROVISIONING
  UPDATING
  ACTIVE
  FAILED
  TERMINATING
  TERMINATED
  DELETING
  DELETED
}

enum PortalType {
  CLOUDFLARE
  DYNU
}

enum TransponderMode {
  PROXY
}

// Hive
model Worker {
  id         String         @id @default(dbgenerated())
  name       String
  status     ResourceStatus @default(QUEUED)
  macAddress String         @unique

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime? @updatedAt
  updatedBy String?

  ownerId String
  owner   Company @relation(fields: [ownerId], references: [id])

  imageId Int
  image   WorkerImage @relation(fields: [imageId], references: [id])

  flavorId Int
  flavor   WorkerFlavor @relation(fields: [flavorId], references: [id])

  storages WorkerDisk[]

  node Node?
}

model WorkerImage {
  id                 Int     @id @default(autoincrement())
  name               String  @unique
  description        String?
  osType             String
  osVersion          String?
  osFamily           String
  imageUrl           String
  architecture       String
  virtualizationType String

  workerStorageTypeId Int?
  workerStorageType   WorkerStorageType? @relation(fields: [workerStorageTypeId], references: [id])

  workers Worker[]
}

model WorkerFamily {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?

  flavors WorkerFlavor[]
}

model WorkerFlavor {
  id       Int    @id @default(autoincrement())
  name     String
  cpuCores Float
  ramMB    Int
  diskGB   Int

  familyId Int
  family   WorkerFamily @relation(fields: [familyId], references: [id])

  workers Worker[]

  @@unique([familyId, name])
}

model WorkerStorageType {
  id          Int  @id @default(autoincrement())
  name        String @unique
  description String?
  persistent  Boolean
  attachable  Boolean
  shared      Boolean

  storages     WorkerDisk[]
  workerImages WorkerImage[]
}

model WorkerDisk {
  id         Int     @id @default(autoincrement())
  name       String
  sizeGiB    Int
  hostPath   String
  mountPoint String?
  isBoot     Boolean @default(false)

  ownerId String
  owner   Company @relation(fields: [ownerId], references: [id])

  storageTypeId Int
  storageType   WorkerStorageType @relation(fields: [storageTypeId], references: [id])

  workerId String?
  worker   Worker? @relation(fields: [workerId], references: [id])

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime @updatedAt
  updatedBy String?
}

// Nucleus
model Atom {
  id     String         @id @default(dbgenerated())
  name   String
  image  String
  status ResourceStatus @default(INACTIVE)

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime @updatedAt
  updatedBy String

  ownerId String
  owner   Company @relation(fields: [ownerId], references: [id])

  node Node?
}

// Mesh
model Zone {
  id          String         @id @default(dbgenerated())
  name        String
  description String?
  status      ResourceStatus @default(QUEUED)
  cidr        String
  gateway     String

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime @updatedAt
  updatedBy String

  ownerId String
  owner   Company @relation(fields: [ownerId], references: [id])

  nodes   Node[]
  portals Portal[]
}

model Node {
  id        String         @id @default(dbgenerated())
  ipAddress String         @unique
  status    ResourceStatus @default(QUEUED)

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime @updatedAt
  updatedBy String

  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id])

  workerId String? @unique
  worker   Worker? @relation(fields: [workerId], references: [id])

  atomId String? @unique
  atom   Atom?   @relation(fields: [atomId], references: [id])

  fibers       Fiber[]
  transponders Transponder[]
}

model Fiber {
  id         Int            @id @default(autoincrement())
  protocol   String
  hostPort   Int?
  targetPort Int
  status     ResourceStatus @default(QUEUED)

  createdAt DateTime @default(now())
  createdBy String

  updatedAt DateTime @updatedAt
  updatedBy String?

  nodeId String
  node   Node   @relation(fields: [nodeId], references: [id])

  @@unique([protocol, hostPort], name: "unique_protocol_hostport")
}

// Orbit
model Portal {
  id          String  @id @default(dbgenerated())
  name        String
  description String?

  address      String         @unique
  type         PortalType
  apiKey       String
  lastSyncAt   DateTime?
  lastPublicIP String?
  status       ResourceStatus @default(QUEUED)

  listenHttp        Boolean @default(true)
  listenHttps       Boolean @default(false)
  sslCertificate    String?
  sslKey            String?
  enableCompression Boolean @default(true)
  cacheEnabled      Boolean @default(true)
  corsEnabled       Boolean @default(true)
  defaultServer     Boolean @default(false)

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String?

  zoneId String?
  zone   Zone?   @relation(fields: [zoneId], references: [id])

  ownerId String
  owner   Company @relation(fields: [ownerId], references: [id])

  transponders Transponder[]
}

model Transponder {
  id     String          @id @default(dbgenerated())
  path   String
  port   Int
  mode   TransponderMode @default(PROXY)
  status ResourceStatus  @default(QUEUED)

  cacheEnabled     Boolean  @default(false)
  addHeaders       Json?
  proxyHeaders     Json?
  proxyReadTimeout Int      @default(60)
  removeHeaders    String[] @default([])
  allowCookies     Boolean  @default(true)
  gzipEnabled      Boolean  @default(false)
  customIPAddress  String?

  priority Int @default(0)

  createdAt DateTime @default(now())
  createdBy String
  updatedAt DateTime @updatedAt
  updatedBy String?

  portalId String
  portal   Portal @relation(fields: [portalId], references: [id])

  nodeId String?
  node   Node?   @relation(fields: [nodeId], references: [id])
}

model Company {
  id          String   @id @default(dbgenerated())
  name        String
  alias       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parentCompanyId String?
  parentCompany   Company? @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id])

  users    User[]
  workers  Worker[]
  zones    Zone[]
  atoms    Atom[]
  storages WorkerDisk[]
  portals  Portal[]
  events   Event[]

  children Company[] @relation("CompanyHierarchy")
}

model User {
  id        String   @id @default(dbgenerated())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id])

  sessions Session[]
}

model Session {
  refreshToken     String @id @default(dbgenerated())
  userId           String
  ipAddress        String
  userAgent        String
  platform         String
  device           String
  browser          String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiredAt DateTime?

  user User @relation(fields: [userId], references: [id])
}

model Event {
  id    Int     @id @default(autoincrement())
  type  String
  notes String?
  data  Json?

  createdAt DateTime @default(now())
  createdBy String

  retries     Int       @default(0)
  processedAt DateTime?
  failedAt    DateTime?
  isVisible   Boolean   @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  resources  EventResource[]
  properties EventProperty[]
}

model EventResource {
  id           Int    @id @default(autoincrement())
  resourceType String
  resourceId   String

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])
}

model EventProperty {
  id      Int    @id @default(autoincrement())
  key     String
  value   String

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  @@unique([eventId, key], name: "unique_event_property")
}
